<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>CloudCare | Matching Donors</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { min-height: 100vh; background: #fff6f6; color: #333; }
        
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 99vh; background: #23282d; z-index: 100; }
        .home-section { padding: 30px; }
        
        .container { max-width: 1000px; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 30px; }
        
        h1 { color: #b71c1c; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #666; margin-bottom: 25px; font-size: 15px; }
        
        .request-info { background: linear-gradient(135deg, #ffebee, #ffcdd2); border-left: 5px solid #d32f2f; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
        .request-info h3 { color: #b71c1c; margin-bottom: 10px; }
        .request-detail-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .request-detail { font-size: 14px; }
        .request-detail-label { font-weight: 600; color: #666; }
        .request-detail-value { color: #d32f2f; font-weight: 700; }
        
        .donor-card { background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 18px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .donor-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .donor-card.selected { background: #e8f5e9; border-color: #4caf50; }
        
        .donor-info { flex: 1; }
        .donor-name { font-weight: 600; font-size: 16px; color: #333; }
        .donor-details { font-size: 13px; color: #666; margin-top: 4px; }
        .donor-badge { display: inline-block; background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-top: 6px; }
        
        .donor-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 14px; }
        .btn-confirm { background: #4caf50; color: #fff; }
        .btn-confirm:hover { background: #2e7d32; }
        .btn-ignore { background: #e53935; color: #fff; }
        .btn-ignore:hover { background: #c62828; }
        .btn-email-all { background: #1976d2; color: #fff; }
        .btn-email-all:hover { background: #1565c0; }
        
        .back-link { margin-bottom: 20px; }
        .back-link a { color: #d32f2f; text-decoration: none; font-weight: 600; }
        .back-link a:hover { text-decoration: underline; }
        
        .empty-state { text-align: center; padding: 40px; }
        .empty-state i { font-size: 48px; color: #ccc; }
        .empty-state p { color: #999; margin-top: 15px; }
        
        .success-msg { background: #c8e6c9; color: #2e7d32; padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; display: none; border-left: 4px solid #2e7d32; }
        .error-msg { background: #ffcdd2; color: #c62828; padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; display: none; border-left: 4px solid #c62828; }
        .info-box { background: #e3f2fd; border-left: 4px solid #1976d2; padding: 12px 16px; border-radius: 4px; margin-bottom: 20px; font-size: 14px; color: #1565c0; }
        .debug-box { background: #f5f5f5; border: 1px dashed #999; padding: 12px; border-radius: 4px; margin-top: 20px; font-size: 12px; color: #666; max-height: 200px; overflow-y: auto; font-family: monospace; }
        
        .action-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #d32f2f; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div th:replace="fragments/sidebar :: sidebar"></div>

<!-- MAIN CONTENT -->
<section class="home-section">
    <div class="back-link">
        <a th:href="@{/patient/donor}">‚Üê Back to Donor Dashboard</a>
    </div>
    
    <div class="container">
        <h1>‚úì Finding Matching Donors...</h1>
        <p class="subtitle">Searching for eligible donors who can help. </p>
        
        <!-- LOADING SPINNER -->
        <div class="loading" id="loadingSpinner">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">Loading eligible donors...</p>
        </div>
        
        <!-- REQUEST INFO DISPLAY -->
        <div class="request-info" id="requestInfo" style="display: none;">
            <h3>üìã Blood Request Details</h3>
            <div class="request-detail-row">
                <div class="request-detail">
                    <div class="request-detail-label">üë§ Requester Name:</div>
                    <div class="request-detail-value" id="requesterName">-</div>
                </div>
                <div class="request-detail">
                    <div class="request-detail-label">üìß Email:</div>
                    <div class="request-detail-value" id="requesterEmail">-</div>
                </div>
            </div>
            <div class="request-detail-row">
                <div class="request-detail">
                    <div class="request-detail-label">ü©∏ Blood Group:</div>
                    <div class="request-detail-value" id="bloodGroupDisplay">-</div>
                </div>
                <div class="request-detail">
                    <div class="request-detail-label">üì¶ Units Needed:</div>
                    <div class="request-detail-value" id="unitsDisplay">-</div>
                </div>
            </div>
            <div class="request-detail-row">
                <div class="request-detail">
                    <div class="request-detail-label">üìÖ Required Date:</div>
                    <div class="request-detail-value" id="requiredDateDisplay">-</div>
                </div>
                <div class="request-detail">
                    <div class="request-detail-label">üè• Medical Reason:</div>
                    <div class="request-detail-value" id="medicalReasonDisplay">-</div>
                </div>
            </div>
        </div>
        
        <!-- INFO BOX -->
        <div class="info-box" id="infoBox" style="display: none;">
            Blood Group: <span id="bloodGroupMatch">-</span> | Found: <span id="donorCountDisplay">0</span> eligible donor(s)
        </div>
        
        <!-- ACTION BUTTONS -->
        <div class="action-bar" id="actionBar" style="display: none;">
            <button class="btn btn-email-all" id="emailAllBtn">üìß Email All Eligible Donors</button>
            <button class="btn btn-confirm" id="emailSelectedBtn" style="margin-left: 8px;" disabled>üìß Email Selected Donors</button>
            <span id="selectionStatus" style="margin-left: auto; font-size: 13px; color: #666;"></span>
        </div>
        
        <!-- MESSAGES -->
        <div class="success-msg" id="successMsg"></div>
        <div class="error-msg" id="errorMsg"></div>
        
        <!-- DONORS LIST -->
        <div id="donorsList"></div>
        
        <!-- EMPTY STATE -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class='bx bx-search'></i>
            <p>No eligible donors found for <strong id="emptyBloodGroup">-</strong> blood group.</p>
            <p style="color: #ccc; font-size: 13px; margin-top: 10px;">Your request has been saved. It will be added to the Pending Requests list.</p>
            <a th:href="@{/patient/donor}" class="btn btn-ignore" style="margin-top: 15px; display: inline-block; text-decoration: none;">Back to Dashboard</a>
        </div>
        
        <!-- DEBUG BOX -->
        <!-- Debug UI removed -->
    </div>
</section>

<script>
    // Debugging disabled in production UI
    const DEBUG = false;

    function logDebug(msg) {
        // no-op when debugging is disabled
        if (!DEBUG) return;
        // kept for future debugging: will only run when DEBUG = true
        console.log('[MATCHING DEBUG]', msg);
    }
    
    document.addEventListener('DOMContentLoaded', async function() {
        logDebug('Page loaded. Parsing URL parameters...');
        
        // Get requestId from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const requestId = urlParams.get('requestId');
        
        if (!requestId) {
            logDebug('ERROR: No requestId found in URL');
            showError('Request ID not found. Please try again.');
            return;
        }
        
        logDebug(`Found requestId: ${requestId}`);
        
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
        
        try {
            // Step 1: Fetch request details
            logDebug(`Fetching request details from /patient/request/api/get/${requestId}...`);
            const requestRes = await fetch(`/patient/request/api/get/${requestId}`);
            const requestData = await requestRes.json();
            
            logDebug(`Request response status: ${requestRes.status}`);
            logDebug(`Request data: ${JSON.stringify(requestData)}`);
            
            if (!requestData.success) {
                logDebug(`ERROR: Request not found or error in response`);
                showError('Request not found.');
                return;
            }
            
            const request = requestData.data;
            logDebug(`Request loaded: ${request.name}, Blood Group: ${request.bloodGroup}`);
            
            // Display request info
            document.getElementById('requesterName').textContent = request.name || '-';
            document.getElementById('requesterEmail').textContent = request.email || '-';
            document.getElementById('bloodGroupDisplay').textContent = request.bloodGroup || '-';
            document.getElementById('bloodGroupMatch').textContent = request.bloodGroup || '-';
            document.getElementById('unitsDisplay').textContent = request.units || '-';
            document.getElementById('requiredDateDisplay').textContent = request.requiredDate || '-';
            document.getElementById('medicalReasonDisplay').textContent = request.medicalReason || 'Not specified';
            document.getElementById('emptyBloodGroup').textContent = request.bloodGroup || '-';
            document.getElementById('requestInfo').style.display = 'block';
            
            // Step 2: Find matching eligible donors
            logDebug(`Finding matching donors for blood group: ${request.bloodGroup}...`);
            const matchRes = await fetch(`/patient/request/api/find-match/${requestId}`);
            const matchData = await matchRes.json();
            
            logDebug(`Match response status: ${matchRes.status}`);
            logDebug(`Match response: ${JSON.stringify(matchData)}`);
            
            if (!matchData.success) {
                logDebug(`ERROR: Failed to find donors - ${matchData.message}`);
                showError(matchData.message || 'Failed to find matching donors.');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('loadingSpinner').style.display = 'none';
                return;
            }
            
            const donors = matchData.donors || [];
            logDebug(`Found ${donors.length} eligible donor(s)`);
            
            if (donors.length === 0) {
                logDebug('No eligible donors found');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('loadingSpinner').style.display = 'none';
                
                // Request stays in Pending list - no action needed
                logDebug('Request will remain in PENDING list awaiting future donors');
                return;
            }
            
            // Display donors
            logDebug(`Displaying ${donors.length} donors...`);
            displayDonors(donors, request, requestId);
            
            // Show action bar
            document.getElementById('infoBox').style.display = 'block';
            document.getElementById('donorCountDisplay').textContent = donors.length;
            document.getElementById('actionBar').style.display = 'flex';
            
            // Wire up Email All button
            document.getElementById('emailAllBtn').addEventListener('click', async function() {
                if (!confirm(`Send detailed email to all ${donors.length} eligible donors?`)) return;
                await sendMatchingEmails(donors, request, requestId);
            });
            
        } catch (err) {
            logDebug(`EXCEPTION: ${err.message}`);
            showError('Error loading matching donors: ' + err.message);
        } finally {
            document.getElementById('loadingSpinner').style.display = 'none';
        }
    });
    
    function displayDonors(donors, request, requestId) {
        logDebug(`displayDonors() called with ${donors.length} donors`);
        const donorsList = document.getElementById('donorsList');
        donorsList.innerHTML = ''; // Clear
        
        // renderList: render given donor list into the UI
        function renderList(list) {
            donorsList.innerHTML = '';
            list.forEach((donor, index) => {
                logDebug(`Rendering donor #${index}: ${donor.name} (${donor.email})`);
                const card = document.createElement('div');
                card.className = 'donor-card';
                card.innerHTML = `
                    <div style="display:flex; align-items:center; gap:12px; width:100%;">
                        <div style="flex-shrink:0;">
                            <input type="checkbox" class="donor-select" data-donor-index="${index}" data-donor-id="${donor.id || ''}" aria-label="Select donor ${donor.name || ''}" />
                        </div>
                        <div class="donor-info">
                            <div class="donor-name">üë§ ${donor.name || 'Unknown'}</div>
                            <div class="donor-details">
                                <strong>üìß Email:</strong> ${donor.email || 'N/A'} | 
                                <strong>üéÇ Age:</strong> ${donor.age || 'N/A'} | 
                                <strong>‚≠ï Blood:</strong> ${donor.bloodGroup || 'N/A'}
                            </div>
                            <div class="donor-details" style="margin-top: 6px;">
                                <strong>üìç Location:</strong> ${donor.location || donor.district ? (donor.district + (donor.thana ? (', ' + donor.thana) : '')) : 'N/A'} | 
                                <strong>ü©∏ Last Donated:</strong> ${donor.lastDonated || donor.lastDonationDate || 'Never'}
                            </div>
                            <div class="donor-badge">‚úì Eligible Donor</div>
                        </div>
                    </div>
                `;
                donorsList.appendChild(card);

                // wire up checkbox selection behavior
                const checkbox = card.querySelector('.donor-select');
                checkbox.addEventListener('change', function(e) {
                    if (this.checked) card.classList.add('selected'); else card.classList.remove('selected');
                    updateSelectionStatus();
                });
            });
        }

        // initial render
        renderList(donors);

        // update selection UI
        function updateSelectionStatus() {
            const selected = Array.from(document.querySelectorAll('.donor-select')).filter(cb => cb.checked);
            const statusEl = document.getElementById('selectionStatus');
            const emailSelectedBtn = document.getElementById('emailSelectedBtn');
            if (selected.length === 0) {
                statusEl.textContent = 'No donors selected';
                emailSelectedBtn.disabled = true;
            } else {
                statusEl.textContent = `${selected.length} selected`;
                emailSelectedBtn.disabled = false;
            }
        }

        // District & Thana filters (no location filter)
        try {
            const actionBar = document.getElementById('actionBar');
            if (actionBar) {
                const existing = document.getElementById('locationFilters');
                if (existing) existing.remove();

                const filterWrap = document.createElement('div');
                filterWrap.id = 'locationFilters';
                filterWrap.style.display = 'flex';
                filterWrap.style.gap = '8px';
                filterWrap.style.alignItems = 'center';

                // District select: show All + all donor districts
                const districtSelect = document.createElement('select');
                const dAll = document.createElement('option'); dAll.value = ''; dAll.text = 'All Districts'; districtSelect.appendChild(dAll);
                const districts = Array.from(new Set(donors.map(d => (d.district || '').trim()).filter(Boolean))).sort();
                districts.forEach(dd => { const o=document.createElement('option'); o.value=dd; o.text=dd; districtSelect.appendChild(o); });

                // Thana select: will be scoped to district when chosen
                const thanaSelect = document.createElement('select');
                const tAll = document.createElement('option'); tAll.value=''; tAll.text='All Thanas'; thanaSelect.appendChild(tAll);
                const allThanas = Array.from(new Set(donors.map(d => (d.thana || '').trim()).filter(Boolean))).sort();
                allThanas.forEach(tt => { const o=document.createElement('option'); o.value=tt; o.text=tt; thanaSelect.appendChild(o); });

                // wire filtering (district + thana only)
                function filterAndRender() {
                    const d = districtSelect.value;
                    const t = thanaSelect.value;
                    let filtered = donors;
                    if (d) filtered = filtered.filter(x => x.district && x.district.toLowerCase() === d.toLowerCase());
                    if (t) filtered = filtered.filter(x => x.thana && x.thana.toLowerCase() === t.toLowerCase());
                    renderList(filtered);
                    updateSelectionStatus();
                }

                districtSelect.addEventListener('change', async function(){
                    const cur = this.value;
                    thanaSelect.innerHTML = '';
                    const optAll = document.createElement('option'); optAll.value=''; optAll.text='All Thanas'; thanaSelect.appendChild(optAll);
                    if (!cur) {
                        // if no district selected, populate thanas from donors
                        const list = donors.map(d => (d.thana||'').trim());
                        Array.from(new Set(list.filter(Boolean))).sort().forEach(tt => { const o=document.createElement('option'); o.value=tt; o.text=tt; thanaSelect.appendChild(o); });
                        filterAndRender();
                        return;
                    }
                    try {
                        const res = await fetch('/api/locations/thanas?district=' + encodeURIComponent(cur));
                        const data = await res.json();
                        if (data && data.thanas) {
                            data.thanas.forEach(tt => { const o=document.createElement('option'); o.value=tt; o.text=tt; thanaSelect.appendChild(o); });
                        } else {
                            // fallback to donors-derived thanas
                            const list = donors.filter(x => x.district && x.district.toLowerCase() === cur.toLowerCase()).map(d => (d.thana||'').trim());
                            Array.from(new Set(list.filter(Boolean))).sort().forEach(tt => { const o=document.createElement('option'); o.value=tt; o.text=tt; thanaSelect.appendChild(o); });
                        }
                    } catch (e) {
                        const list = donors.filter(x => x.district && x.district.toLowerCase() === cur.toLowerCase()).map(d => (d.thana||'').trim());
                        Array.from(new Set(list.filter(Boolean))).sort().forEach(tt => { const o=document.createElement('option'); o.value=tt; o.text=tt; thanaSelect.appendChild(o); });
                    }
                    filterAndRender();
                });
                thanaSelect.addEventListener('change', filterAndRender);

                filterWrap.appendChild(districtSelect);
                filterWrap.appendChild(thanaSelect);
                actionBar.insertBefore(filterWrap, actionBar.firstChild);
            }
        } catch (err) {
            logDebug('Filter setup failed: ' + err.message);
        }

        // wire Email Selected button (robust)
        const emailSelectedBtn = document.getElementById('emailSelectedBtn');
        // replace existing handler to avoid duplicate listeners
        emailSelectedBtn.onclick = async function() {
            try {
                const selectedCheckboxes = Array.from(document.querySelectorAll('.donor-select')).filter(cb => cb.checked);
                if (selectedCheckboxes.length === 0) {
                    alert('Please select one or more donors to email.');
                    return;
                }

                // build donor objects from selected by matching id against original donors array
                let donorsToSend = selectedCheckboxes.map(cb => {
                    const id = cb.getAttribute('data-donor-id');
                    return donors.find(d => String(d.id) === String(id));
                }).filter(Boolean);

                // Only keep donors with an email
                donorsToSend = donorsToSend.filter(d => d && d.email && d.email.trim() !== '');
                if (donorsToSend.length === 0) {
                    alert('Selected donors do not have email addresses. Please select donors with valid emails.');
                    return;
                }

                if (!confirm(`Send detailed email to ${donorsToSend.length} selected donor(s)?`)) return;

                // disable the button while sending
                emailSelectedBtn.disabled = true;
                emailSelectedBtn.textContent = 'Sending...';

                await sendMatchingEmails(donorsToSend, request, requestId);
            } catch (e) {
                console.error('Error sending selected emails:', e);
                showError('Failed to send selected emails: ' + (e.message || e));
            } finally {
                emailSelectedBtn.disabled = false;
                emailSelectedBtn.textContent = 'üìß Email Selected Donors';
            }
        };
    }
    
    async function sendMatchingEmails(donors, request, requestId) {
        logDebug(`sendMatchingEmails() called. Sending to ${donors.length} donors...`);
        
        try {
            // ensure we have a requestId; fallback to request.id or URL param
            let rid = requestId;
            if (!rid && request && request.id) rid = request.id;
            if (!rid) {
                const qp = new URLSearchParams(window.location.search);
                rid = qp.get('requestId');
            }
            if (!rid) {
                showError('Request ID is missing. Cannot send emails.');
                return;
            }

            const payload = {
                requestId: rid,
                donors: donors.map(d => ({ id: d.id, name: d.name, email: d.email }))
            };
            
            logDebug(`POST payload: ${JSON.stringify(payload)}`);
            
            const res = await fetch('/patient/request/api/send-match-emails', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const responseData = await res.json();
            logDebug(`Email response status: ${res.status}`);
            logDebug(`Email response: ${JSON.stringify(responseData)}`);
            
            if (responseData.success) {
                logDebug(`‚úì Emails sent successfully to ${responseData.emailsSent} donor(s). Request status updated to MATCHED.`);
                showSuccess(`‚úì Emails sent to ${responseData.emailsSent} eligible donor(s)! They will contact you soon.`);
                
                // Redirect to pending requests after 2 seconds
                setTimeout(() => {
                    logDebug('Redirecting to pending requests list...');
                    window.location.href = '/patient/request/pending-requests';
                }, 2000);
            } else {
                logDebug(`ERROR sending emails: ${responseData.message}`);
                showError('Failed to send emails: ' + (responseData.message || 'Unknown error'));
            }
        } catch (err) {
            logDebug(`EXCEPTION in sendMatchingEmails: ${err.message}`);
            showError('Network error: ' + err.message);
        }
    }
    
    function showSuccess(msg) {
        const box = document.getElementById('successMsg');
        box.textContent = msg;
        box.style.display = 'block';
    }
    
    function showError(msg) {
        const box = document.getElementById('errorMsg');
        box.textContent = msg;
        box.style.display = 'block';
    }
</script>

</body>
</html>
