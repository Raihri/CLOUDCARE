<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Daily To-Do | CloudCare</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/style-todo.css}">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>

<body>

<!-- Sidebar -->
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<!-- Main Content -->
<main class="home-section">

    <!-- Header -->
    <header style="display:flex; align-items:center; justify-content:space-between; gap:20px; 
                     margin-bottom:32px; flex-wrap:wrap;">
        <div>
            <h1 style="font-size:2.4rem; color:#040d72; font-weight:700; margin:0;">
                Daily To-Do
            </h1>
            <p style="color:#666; margin:8px 0 0; font-size:1.1rem;">
                Focus on today. Win the day.
            </p>
        </div>
        <div style="color:#666; font-size:1.15rem;">
            Today: <strong th:text="${#temporals.format(today, 'EEEE, MMM dd')}"></strong>
        </div>
    </header>

    <!-- Stats Grid -->
    <section class="stats-grid">
        <div class="stat-card">
            <div class="stat-num" th:text="${#lists.size(tasks.?[isActive()])}">0</div>
            <div class="stat-label">Today's Tasks</div>
        </div>

        <div class="stat-card">
            <div class="stat-num success" th:text="${completedTodayCount}">0</div>
            <div class="stat-label">Completed Today</div>
        </div>

        <div class="stat-card">
            <div class="stat-num" style="color:#f59e0b;" 
                 th:text="${#aggregates.sum(tasks.?[completed].![streak])}">0</div>
            <div class="stat-label">Total Streaks</div>
        </div>

        <div class="stat-card">
            <div class="stat-num success" 
                 th:text="${(#aggregates.avg(tasks.?[isActive()].![getWeeklyFulfillment()])?.intValue() ?: 0) + '%'}">
                0%
            </div>
            <div class="stat-label">Daily Completion</div>
        </div>
    </section>

    <!-- Action Buttons -->
    <div class="actions" style="margin:36px 0;">
        <a href="/tasks/today" target="_blank" class="btn btn-primary">
            <i class='bx bx-list-check'></i> Open Today's Task List
        </a>
        <a th:href="@{/tasks/new}" class="btn btn-outline">
            <i class='bx bx-plus'></i> Add Task
        </a>
    </div>

    <!-- Task List -->
    <section class="tasks-grid" th:unless="${showSuccessModal == true}">
        <div th:each="task : ${tasks.?[isActive()]}" class="task-card">
            <div>
                <!-- Title + Priority -->
                <div style="display:flex; justify-content:space-between; align-items:start; gap:16px;">
                    <div>
                        <h3 style="font-size:1.25rem; font-weight:700; color:#040d72; margin:0;" 
                            th:text="${task.title}">Task Title</h3>
                        <div style="color:#666; margin-top:4px;" th:text="${task.category}">Category</div>
                    </div>
                    <div style="font-size:1.6rem; font-weight:600;">
                        <span th:text="${task.priority == 'High' ? 'High priority' : 
                                          task.priority == 'Medium' ? 'Medium priority' : 'Low priority'}">
                            High priority
                        </span>
                    </div>
                </div>

                <!-- Description -->
                <p style="margin:12px 0 0; color:#444; line-height:1.5;" 
                   th:text="${task.description ?: 'No description.'}">
                    No description.
                </p>
            </div>

            <!-- Footer: Status + Actions -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <div>
                    <span th:class="${task.completed} ? 'badge completed' : 
                                    (task.status == 'In Progress' ? 'badge inprogress' : 'badge pending')"
                          th:text="${task.completed ? 'Completed' : 
                                    (task.status == 'In Progress' ? 'In Progress' : 'Pending')}">
                        Pending
                    </span>
                    <div style="color:#666; font-size:0.95rem; margin-top:6px;">Due today</div>
                </div>

                <div class="task-actions">
                    <a th:href="@{/tasks/edit/{id}(id=${task.id})}" style="color:#040d72;">Edit</a>
                    <a th:href="@{/tasks/complete/{id}(id=${task.id})}" style="color:#22c55e;">Done</a>
                    <a th:href="@{/tasks/delete/{id}(id=${task.id})}"
                       onclick="return confirm('Delete this task?')" style="color:#ef4444;">Delete</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Success Modal (All tasks done) -->
    <div th:if="${showSuccessModal == true}" class="modal-backdrop">
        <div class="modal" style="max-width:620px;">
            <div style="background:linear-gradient(90deg,#10b981,#34d399); color:white; padding:24px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; font-size:1.4rem;">Great Job!</h3>
                    <a th:href="@{/tasks}" style="color:white; font-size:28px; text-decoration:none;">×</a>
                </div>
                <div style="margin-top:8px; font-size:1.1rem;" th:text="${successMessage}">Well done!</div>
            </div>

            <div style="padding:32px;">
                <h4 style="color:#040d72; font-weight:600; margin-bottom:16px;">Your Active Tasks Today</h4>

                <div th:each="task : ${tasks.?[isActive()]}" 
                     style="background:#f7fbff; padding:16px; border-radius:12px; margin-bottom:12px; 
                            border-left:5px solid #040d72;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700; color:#040d72;" th:text="${task.title}">Task</div>
                            <div style="color:#666; margin-top:4px;" th:text="${task.category}">Category</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700; color:#040d72;" th:text="${task.streak} + 'd'">0d</div>
                            <div style="color:#666; font-size:0.95rem;">day streak</div>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(tasks.?[isActive()])}" 
                     style="text-align:center; padding:32px; color:#666;">
                    No active tasks. Enjoy your day!
                </div>

                <div style="text-align:center; margin-top:24px;">
                    <a th:href="@{/tasks}" class="btn btn-primary" style="padding:14px 36px;">
                        Close & Continue
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div th:if="${showSuccessModal != true && #lists.isEmpty(tasks.?[isActive()])}" class="empty-state">
        <div style="font-size:80px; color:#22c569;">Checkmark</div>
        <h3 style="margin:20px 0 12px; color:#040d72; font-size:1.8rem;">Your day is clear!</h3>
        <p style="color:#666; font-size:1.1rem;">No pending tasks — well done!</p>
    </div>

</main>
</body>
</html>