<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>Donor Analysis - CloudCare Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root{
            --primary-blue:#1a73e8;
            --primary-dark:#0b2142;
            --card-shadow:0 10px 30px rgba(0,0,0,0.08);
        }

        *{box-sizing:border-box;margin:0;padding:0}

        body{
            font-family:'Inter','Poppins',sans-serif;
            background:linear-gradient(135deg,#f7f9fc 0%,#eef2f7 100%);
            color:var(--primary-dark);
            padding:28px;
        }

        .container{max-width:1100px;margin:0 auto}

        .header{margin-bottom:26px}

        h1{
            font-size:2rem;
            font-weight:700;
            background:linear-gradient(90deg,var(--primary-blue),#0b57d0);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }

        .back{
            display:inline-block;
            margin-bottom:10px;
            color:var(--primary-blue);
            text-decoration:none;
            font-weight:600;
        }

        .stats-container{
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:18px;
            margin-bottom:22px;
        }

        .stat-card{
            background:white;
            border-radius:12px;
            padding:18px;
            box-shadow:var(--card-shadow);
            text-align:center;
            transition:transform 180ms ease, box-shadow 180ms ease;
        }

        /* gentle color accents for the three stat cards */
        .stats-container .stat-card:nth-child(1){ background:linear-gradient(135deg,#eef2ff,#dbeafe); color:#0b3a8c }
        .stats-container .stat-card:nth-child(2){ background:linear-gradient(135deg,#ecfdf5,#dcfce7); color:#065f46 }
        .stats-container .stat-card:nth-child(3){ background:linear-gradient(135deg,#fff7ed,#ffedd5); color:#92400e }
        .stats-container .stat-card:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(11,33,66,0.12) }

        .stat-card h3{font-size:1.1rem;margin-bottom:8px;color:#556}
        .stat-card .value{font-size:28px;font-weight:700}

        .chart-row{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:18px;
        }

        .card{
            background:white;
            padding:18px;
            border-radius:12px;
            box-shadow:var(--card-shadow);
        }

        .donor-list{
            margin-top:20px;
            display:grid;
            grid-template-columns:1fr;
            gap:12px;
        }

        .donor-card{
            background:white;
            border-radius:12px;
            padding:16px;
            box-shadow:var(--card-shadow);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .donor-meta{
            display:flex;
            gap:14px;
            align-items:center;
        }

        .donor-avatar{
            width:56px;
            height:56px;
            border-radius:50%;
            background:#f0f4ff;
            color:var(--primary-blue);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            font-size:20px;
        }

        .donor-info strong{display:block;font-size:1rem}

        .status-badge{
            padding:6px 12px;
            border-radius:999px;
            font-weight:700;
            color:white;
            font-size:13px;
            text-align:center;
        }

        .status-eligible{
            background:linear-gradient(135deg,#27ae60,#2ecc71);
        }

        .status-not{
            background:linear-gradient(135deg,#e74c3c,#c0392b);
        }

        @media (max-width:800px){
            .stats-container{grid-template-columns:1fr}
            .chart-row{grid-template-columns:1fr}
        }
    </style>
</head>

<body>
<div class="container">

    <!-- Header -->
    <div class="header">
        <a href="/admin/home" class="back">← Back</a>
        <h1>Donor Management — Overview & Analysis</h1>
        <p style="color:#616e7a;margin-top:6px">
            Snapshot of donor registrations and blood request trends
        </p>
    </div>

    <!-- Stats -->
    <div class="stats-container">
        <div class="stat-card">
            <h3>Total Donors</h3>
            <div class="value" th:text="${totalDonors != null ? totalDonors : 0}">0</div>
        </div>

        <div class="stat-card">
            <h3>Eligible Donors</h3>
            <div class="value" th:text="${eligibleDonors != null ? eligibleDonors : 0}">0</div>
        </div>

        <div class="stat-card">
            <h3>Requests by Status</h3>
            <div th:if="${requestsByStatus != null}" th:each="entry : ${requestsByStatus}" style="font-weight:600">
                <span th:text="${entry.key + ' : ' + entry.value}">Pending : 0</span>
            </div>
            <div th:if="${requestsByStatus == null}" style="color:rgba(11,33,66,0.6)">No requests</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-row">
        <div class="card">
            <h3>Donors by Blood Group</h3>
            <canvas id="bloodChart" height="240"></canvas>
        </div>

        <div class="card">
            <h3>Requests by Status</h3>
            <canvas id="statusChart" height="240"></canvas>
        </div>
    </div>

    <!-- Management Buttons + Lists -->
    <div style="margin-top:18px;" class="card">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
            <button id="showDonorsBtn" style="background:#1976d2;color:#fff;padding:10px 14px;border-radius:8px;border:0;font-weight:700;cursor:pointer">Donor List</button>
            <button id="showRequestsBtn" style="background:#d32f2f;color:#fff;padding:10px 14px;border-radius:8px;border:0;font-weight:700;cursor:pointer">Request List</button>
            <div style="margin-left:auto;color:#666;font-size:13px">Use search/filter to narrow results, click edit or delete for actions.</div>
        </div>

        <div id="managementArea" style="margin-top:16px;"></div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script th:inline="javascript">
/*<![CDATA[*/
    const donorsByBlood = /*[[${donorsByBlood}]]*/ {};
    const requestsByStatus = /*[[${requestsByStatus}]]*/ {};

    const bloodLabels = Object.keys(donorsByBlood);
    const bloodData = bloodLabels.map(k => donorsByBlood[k]);

    const statusLabels = Object.keys(requestsByStatus);
    const statusData = statusLabels.map(k => requestsByStatus[k]);

    if (bloodLabels.length > 0) {
        new Chart(document.getElementById('bloodChart'), {
            type: 'pie',
            data: {
                labels: bloodLabels,
                datasets: [{
                    data: bloodData,
                    backgroundColor: ['#d32f2f','#1976d2','#fbc02d','#43a047','#8e44ad','#ff7043','#90a4ae']
                }]
            }
        });
    }

    if (statusLabels.length > 0) {
        new Chart(document.getElementById('statusChart'), {
            type: 'bar',
            data: {
                labels: statusLabels,
                datasets: [{
                    label: 'Requests',
                    data: statusData,
                    backgroundColor: '#1976d2'
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } }
            }
        });
    }
/*]]>*/
</script>

<script>
(() => {
    const mgmt = document.getElementById('managementArea');
    const showDonorsBtn = document.getElementById('showDonorsBtn');
    const showRequestsBtn = document.getElementById('showRequestsBtn');

    if (showDonorsBtn) showDonorsBtn.addEventListener('click', () => showDonorList());
    if (showRequestsBtn) showRequestsBtn.addEventListener('click', () => showRequestList());

    // --- Location helpers (caching) ---
    let cachedDistricts = null;
    async function ensureLocationOptions() {
        if (cachedDistricts) return;
        try {
            const r = await fetch('/api/locations/districts');
            const j = await r.json();
            cachedDistricts = j.districts || j.data || [];
        } catch (e) { cachedDistricts = []; }
    }

    async function loadThanasForSelect(thanaSelect, district) {
        if (!district) { thanaSelect.innerHTML = `<option value="">(any)</option>`; return; }
        try {
            const r = await fetch('/api/locations/thanas?district=' + encodeURIComponent(district));
            const j = await r.json();
            const list = j.thanas || j.data || [];
            thanaSelect.innerHTML = `<option value="">(any)</option>` + list.map(t => `<option>${escapeHtml(t)}</option>`).join('');
        } catch (e) { thanaSelect.innerHTML = `<option value="">(error)</option>`; }
    }

    async function awaitPopulateLocationSelect(districtSelectId, thanaSelectId) {
        await ensureLocationOptions();
        const ds = document.getElementById(districtSelectId);
        const ts = document.getElementById(thanaSelectId);
        if (!ds) return;
        ds.innerHTML = `<option value="">All Districts</option>` + (cachedDistricts.map(d=> `<option>${escapeHtml(d)}</option>`).join(''));
        ds.addEventListener('change', async () => {
            const val = ds.value;
            if (!val) { ts.innerHTML = `<option value="">All Thanas</option>`; return; }
            await loadThanasForSelect(ts, val);
        });
    }

    async function populateDistrictSelectInRow(districtSelect, thanaSelect) {
        await ensureLocationOptions();
        districtSelect.innerHTML = `<option value="">(select)</option>` + cachedDistricts.map(d => `<option>${escapeHtml(d)}</option>`).join('');
        districtSelect.addEventListener('change', async () => {
            await loadThanasForSelect(thanaSelect, districtSelect.value);
        });
    }

    // --- Donors ---
    async function showDonorList() {
        mgmt.innerHTML = `<div style="padding:12px">Loading donors…</div>`;
        try {
            const res = await fetch('/patient/donor/api/list');
            const j = await res.json();
            if (!j.success) throw new Error(j.error || 'Failed');
            await ensureLocationOptions();
            renderDonorTable(j.donors || []);
        } catch (e) {
            mgmt.innerHTML = `<div style="color:#b71c1c;padding:12px">Error loading donors: ${e.message}</div>`;
        }
    }

    function renderDonorTable(donors) {
        mgmt.innerHTML = `
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-wrap:wrap">
                <input id="donorFilterName" placeholder="Filter by Name" style="flex:1;min-width:180px;padding:8px;border-radius:6px;border:1px solid #ddd">
                <select id="donorFilterBlood" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="">All Blood Groups</option>
                    <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                    <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
                </select>
                <select id="donorFilterDistrict" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="">All Districts</option>
                </select>
                <select id="donorFilterThana" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="">All Thanas</option>
                </select>
                <select id="donorStatusFilter" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="">All Statuses</option>
                    <option>Available</option>
                    <option>Not Available</option>
                    <option>Pending</option>
                </select>
            </div>
            <div style="overflow:auto;max-height:520px;border-top:1px solid #eee;margin-top:10px">
                <table class="urgent-table" style="width:100%;border-collapse:collapse;font-size:14px">
                    <thead><tr>
                        <th style="padding:8px;text-align:left">Name</th>
                        <th style="padding:8px;text-align:left">Blood</th>
                        <th style="padding:8px;text-align:left">District / Thana</th>
                        <th style="padding:8px;text-align:left">Contact</th>
                        <th style="padding:8px;text-align:left">Status</th>
                        <th style="padding:8px;text-align:right">Actions</th>
                    </tr></thead>
                    <tbody id="donorTbody"></tbody>
                </table>
            </div>
        `;

        awaitPopulateLocationSelect('donorFilterDistrict', 'donorFilterThana');

        const tbody = document.getElementById('donorTbody');
        function populate(list) {
            tbody.innerHTML = list.map(d => `
                <tr data-id="${d.id}">
                    <td class="d-name" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml(d.name || '')}</td>
                    <td class="d-blood" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml(d.bloodGroup || '')}</td>
                    <td class="d-loc" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml((d.district? d.district : '') + (d.thana ? (' / ' + d.thana) : ''))}</td>
                    <td class="d-contact" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml(d.contact || '')}</td>
                    <td class="d-status" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml(d.status||'')}</td>
                    <td style="padding:10px;border-bottom:1px solid #f1f1f1;text-align:right">
                        <button data-id="${d.id}" class="editDonor btn btn-warning" style="margin-right:8px">Edit</button>
                        <button data-id="${d.id}" class="deleteDonor btn btn-danger">Delete</button>
                    </td>
                </tr>
            `).join('');

            Array.from(document.getElementsByClassName('deleteDonor')).forEach(b => {
                b.addEventListener('click', async (ev) => {
                    const id = ev.currentTarget.dataset.id;
                    if (!confirm('Delete donor #' + id + '? This cannot be undone.')) return;
                    await deleteDonor(id);
                });
            });

            Array.from(document.getElementsByClassName('editDonor')).forEach(b => {
                b.addEventListener('click', (ev) => {
                    const id = ev.currentTarget.dataset.id;
                    makeDonorRowEditable(id);
                });
            });
        }

        const nameInput = document.getElementById('donorFilterName');
        const bloodSelect = document.getElementById('donorFilterBlood');
        const districtSelect = document.getElementById('donorFilterDistrict');
        const thanaSelect = document.getElementById('donorFilterThana');
        const statusSelect = document.getElementById('donorStatusFilter');

        function runFilter() {
            const name = nameInput.value.toLowerCase();
            const bg = bloodSelect.value;
            const district = districtSelect.value;
            const thana = thanaSelect.value;
            const status = statusSelect.value;
            const filtered = donors.filter(d => {
                if (name && !(d.name||'').toLowerCase().includes(name)) return false;
                if (bg && (d.bloodGroup||'') !== bg) return false;
                if (district && (d.district||'') !== district) return false;
                if (thana && (d.thana||'') !== thana) return false;
                if (status && (d.status||'') !== status) return false;
                return true;
            });
            populate(filtered);
        }

        [nameInput, bloodSelect, districtSelect, thanaSelect, statusSelect].forEach(el => {
            if (el) el.addEventListener('change', runFilter);
            if (el) el.addEventListener('input', runFilter);
        });

        populate(donors);
    }

    // inline edit for donor row
    async function makeDonorRowEditable(id) {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (!row) return;
        const res = await fetch('/patient/donor/api/get/' + id);
        const j = await res.json();
        if (!j.success) { alert('Donor not found'); return; }
        const d = j.data;
        row.querySelector('.d-name').innerHTML = `<input class="inp-name" value="${escapeHtml(d.name||'')}" style="padding:6px;border-radius:4px;border:1px solid #ddd;width:180px">`;
        row.querySelector('.d-blood').innerHTML = `<select class="inp-blood"><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option></select>`;
        row.querySelector('.d-blood').querySelector('select').value = d.bloodGroup || '';
        row.querySelector('.d-loc').innerHTML = `<select class="inp-district" style="margin-right:6px"></select><select class="inp-thana"></select>`;
        await populateDistrictSelectInRow(row.querySelector('.inp-district'), row.querySelector('.inp-thana'));
        if (d.district) row.querySelector('.inp-district').value = d.district;
        if (d.thana) await loadThanasForSelect(row.querySelector('.inp-thana'), d.district).then(()=> row.querySelector('.inp-thana').value = d.thana);
        row.querySelector('.d-contact').innerHTML = `<input class="inp-contact" value="${escapeHtml(d.contact||'')}" style="padding:6px;border-radius:4px;border:1px solid #ddd;width:140px">`;
        row.querySelector('.d-status').innerHTML = `<select class="inp-status"><option>Available</option><option>Not Available</option><option>Pending</option></select>`;
        row.querySelector('.inp-status').value = d.status || '';
        const actionsCell = row.querySelector('td:last-child');
        actionsCell.innerHTML = `<button class="saveDonor btn btn-success">Save</button><button class="cancelDonor btn btn-secondary">Cancel</button>`;
        actionsCell.querySelector('.cancelDonor').addEventListener('click', showDonorList);
        actionsCell.querySelector('.saveDonor').addEventListener('click', async () => {
            const payload = {
                name: row.querySelector('.inp-name').value,
                bloodGroup: row.querySelector('.inp-blood').value,
                district: row.querySelector('.inp-district').value,
                thana: row.querySelector('.inp-thana').value,
                contact: row.querySelector('.inp-contact').value,
                status: row.querySelector('.inp-status').value
            };
            try {
                const up = await fetch('/patient/donor/api/update/' + id, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const r = await up.json();
                if (!r.success) throw new Error(r.error || r.message || 'Update failed');
                alert('Donor updated');
                showDonorList();
            } catch (e) { alert('Error: ' + e.message); }
        });
    }

    // --- Requests ---
    async function showRequestList() {
        mgmt.innerHTML = `<div style="padding:12px">Loading requests…</div>`;
        try {
            const res = await fetch('/patient/request/api/list');
            const j = await res.json();
            if (!j.success) throw new Error(j.message || 'Failed');
            await ensureLocationOptions();
            renderRequestTable(j.data || []);
        } catch (e) {
            mgmt.innerHTML = `<div style="color:#b71c1c;padding:12px">Error loading requests: ${e.message}</div>`;
        }
    }

    function renderRequestTable(requests) {
        mgmt.innerHTML = `
            <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-wrap:wrap">
                <input id="reqFilterName" placeholder="Filter by Name" style="flex:1;min-width:180px;padding:8px;border-radius:6px;border:1px solid #ddd">
                <select id="reqFilterBlood" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="">All Blood Groups</option>
                    <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                    <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
                </select>
                <select id="reqFilterDistrict" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="">All Districts</option>
                </select>
                <select id="reqFilterThana" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="">All Thanas</option>
                </select>
                <select id="reqStatusFilter" style="padding:8px;border-radius:6px;border:1px solid #ddd">
                    <option value="">All Statuses</option>
                    <option>Pending</option>
                    <option>Matched</option>
                    <option>Confirmed</option>
                </select>
            </div>
            <div style="overflow:auto;max-height:520px;border-top:1px solid #eee;margin-top:10px">
                <table class="urgent-table" style="width:100%;border-collapse:collapse;font-size:14px">
                    <thead><tr>
                        <th style="padding:8px;text-align:left">Name</th>
                        <th style="padding:8px;text-align:left">Blood</th>
                        <th style="padding:8px;text-align:left">Units</th>
                        <th style="padding:8px;text-align:left">District / Thana</th>
                        <th style="padding:8px;text-align:left">Status</th>
                        <th style="padding:8px;text-align:right">Actions</th>
                    </tr></thead>
                    <tbody id="reqTbody"></tbody>
                </table>
            </div>
        `;

        awaitPopulateLocationSelect('reqFilterDistrict', 'reqFilterThana');

        const tbody = document.getElementById('reqTbody');
        function populate(list) {
            tbody.innerHTML = list.map(r => `
                <tr data-id="${r.id}">
                    <td class="r-name" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml(r.name || '')}</td>
                    <td class="r-blood" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml(r.bloodGroup || '')}</td>
                    <td class="r-units" style="padding:10px;border-bottom:1px solid #f1f1f1">${r.units || 0}</td>
                    <td class="r-loc" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml((r.district? r.district : '') + (r.thana ? (' / ' + r.thana) : ''))}</td>
                    <td class="r-status" style="padding:10px;border-bottom:1px solid #f1f1f1">${escapeHtml(r.status||'')}</td>
                    <td style="padding:10px;border-bottom:1px solid #f1f1f1;text-align:right">
                        <button data-id="${r.id}" class="editReq btn btn-warning" style="margin-right:8px">Edit</button>
                        <button data-id="${r.id}" class="deleteReq btn btn-danger">Delete</button>
                    </td>
                </tr>
            `).join('');

            Array.from(document.getElementsByClassName('deleteReq')).forEach(b => {
                b.addEventListener('click', async (ev) => {
                    const id = ev.currentTarget.dataset.id;
                    if (!confirm('Delete request #' + id + '?')) return;
                    await deleteRequest(id);
                });
            });

            Array.from(document.getElementsByClassName('editReq')).forEach(b => {
                b.addEventListener('click', (ev) => {
                    const id = ev.currentTarget.dataset.id;
                    makeRequestRowEditable(id);
                });
            });
        }

        const nameInput = document.getElementById('reqFilterName');
        const bloodSelect = document.getElementById('reqFilterBlood');
        const districtSelect = document.getElementById('reqFilterDistrict');
        const thanaSelect = document.getElementById('reqFilterThana');
        const statusSelect = document.getElementById('reqStatusFilter');

        function runFilter() {
            const name = nameInput.value.toLowerCase();
            const bg = bloodSelect.value;
            const district = districtSelect.value;
            const thana = thanaSelect.value;
            const status = statusSelect.value;
            const filtered = requests.filter(r => {
                if (name && !(r.name||'').toLowerCase().includes(name)) return false;
                if (bg && (r.bloodGroup||'') !== bg) return false;
                if (district && (r.district||'') !== district) return false;
                if (thana && (r.thana||'') !== thana) return false;
                if (status && (r.status||'') !== status) return false;
                return true;
            });
            populate(filtered);
        }

        [nameInput, bloodSelect, districtSelect, thanaSelect, statusSelect].forEach(el => {
            if (el) el.addEventListener('change', runFilter);
            if (el) el.addEventListener('input', runFilter);
        });

        populate(requests);
    }

    // inline edit for request
    async function makeRequestRowEditable(id) {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (!row) return;
        const res = await fetch('/patient/request/api/get/' + id);
        const j = await res.json();
        if (!j.success) { alert('Request not found'); return; }
        const r = j.data;
        row.querySelector('.r-name').innerHTML = `<input class="inp-name" value="${escapeHtml(r.name||'')}" style="padding:6px;border-radius:4px;border:1px solid #ddd;width:160px">`;
        row.querySelector('.r-blood').innerHTML = `<select class="inp-blood"><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option></select>`;
        row.querySelector('.r-blood').querySelector('select').value = r.bloodGroup || '';
        row.querySelector('.r-units').innerHTML = `<input class="inp-units" type="number" value="${r.units||1}" style="width:80px;padding:6px;border-radius:4px;border:1px solid #ddd">`;
        row.querySelector('.r-loc').innerHTML = `<select class="inp-district" style="margin-right:6px"></select><select class="inp-thana"></select>`;
        await populateDistrictSelectInRow(row.querySelector('.inp-district'), row.querySelector('.inp-thana'));
        if (r.district) row.querySelector('.inp-district').value = r.district;
        if (r.thana) await loadThanasForSelect(row.querySelector('.inp-thana'), r.district).then(()=> row.querySelector('.inp-thana').value = r.thana);
        row.querySelector('.r-status').innerHTML = `<select class="inp-status"><option>Pending</option><option>Matched</option><option>Confirmed</option></select>`;
        row.querySelector('.inp-status').value = r.status || '';
        const actionsCell = row.querySelector('td:last-child');
        actionsCell.innerHTML = `<button class="saveReq btn btn-success">Save</button><button class="cancelReq btn btn-secondary">Cancel</button>`;
        actionsCell.querySelector('.cancelReq').addEventListener('click', showRequestList);
        actionsCell.querySelector('.saveReq').addEventListener('click', async () => {
            const payload = {
                name: row.querySelector('.inp-name').value,
                bloodGroup: row.querySelector('.inp-blood').value,
                units: parseInt(row.querySelector('.inp-units').value || '1',10),
                district: row.querySelector('.inp-district').value,
                thana: row.querySelector('.inp-thana').value,
                status: row.querySelector('.inp-status').value
            };
            try {
                const up = await fetch('/patient/request/api/update/' + id, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const r = await up.json();
                if (!r.success) throw new Error(r.message || 'Update failed');
                alert('Request updated');
                showRequestList();
            } catch (e) { alert('Error: ' + e.message); }
        });
    }

    // delete helpers
    async function deleteDonor(id) {
        try {
            const res = await fetch('/patient/donor/api/delete/' + id, { method: 'DELETE' });
            const j = await res.json();
            if (!j.success) throw new Error(j.message || 'Delete failed');
            alert('Donor deleted');
            showDonorList();
        } catch (e) { alert('Error: ' + e.message); }
    }

    async function deleteRequest(id) {
        try {
            const res = await fetch('/patient/request/api/delete/' + id, { method: 'DELETE' });
            const j = await res.json();
            if (!j.success) throw new Error(j.message || 'Delete failed');
            alert('Request deleted');
            showRequestList();
        } catch (e) { alert('Error: ' + e.message); }
    }

    function escapeHtml(s) { return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;'}[c])); }

    // default: do not auto-load to avoid unexpected calls; user clicks button
})();
</script>

</body>
</html>
