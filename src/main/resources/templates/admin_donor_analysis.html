<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>Donor Analysis - CloudCare Admin</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root{
            --primary-blue:#1a73e8;
            --primary-dark:#0b2142;
            --card-shadow:0 10px 30px rgba(0,0,0,0.08);
        }

        *{box-sizing:border-box;margin:0;padding:0}

        body{
            font-family:'Inter','Poppins',sans-serif;
            background:linear-gradient(135deg,#f7f9fc 0%,#eef2f7 100%);
            color:var(--primary-dark);
            padding:28px;
        }

        .container{max-width:1100px;margin:0 auto}

        .header{margin-bottom:26px}

        h1{
            font-size:2rem;
            font-weight:700;
            background:linear-gradient(90deg,var(--primary-blue),#0b57d0);
            -webkit-background-clip:text;
            background-clip:text;
            color:transparent;
        }

        .back{
            display:inline-block;
            margin-bottom:10px;
            color:var(--primary-blue);
            text-decoration:none;
            font-weight:600;
        }

        .stats-container{
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:18px;
            margin-bottom:22px;
        }

        .stat-card{
            background:white;
            border-radius:12px;
            padding:18px;
            box-shadow:var(--card-shadow);
            text-align:center;
            transition:transform 180ms ease, box-shadow 180ms ease;
        }

        /* gentle color accents for the three stat cards */
        .stats-container .stat-card:nth-child(1){ background:linear-gradient(135deg,#eef2ff,#dbeafe); color:#0b3a8c }
        .stats-container .stat-card:nth-child(2){ background:linear-gradient(135deg,#ecfdf5,#dcfce7); color:#065f46 }
        .stats-container .stat-card:nth-child(3){ background:linear-gradient(135deg,#fff7ed,#ffedd5); color:#92400e }
        .stats-container .stat-card:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(11,33,66,0.12) }

        .stat-card h3{font-size:1.1rem;margin-bottom:8px;color:#556}
        .stat-card .value{font-size:28px;font-weight:700}

        .chart-row{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:18px;
        }

        .card{
            background:white;
            padding:18px;
            border-radius:12px;
            box-shadow:var(--card-shadow);
        }

        .donor-list{
            margin-top:20px;
            display:grid;
            grid-template-columns:1fr;
            gap:12px;
        }

        .donor-card{
            background:white;
            border-radius:12px;
            padding:16px;
            box-shadow:var(--card-shadow);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .donor-meta{
            display:flex;
            gap:14px;
            align-items:center;
        }

        .donor-avatar{
            width:56px;
            height:56px;
            border-radius:50%;
            background:#f0f4ff;
            color:var(--primary-blue);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:700;
            font-size:20px;
        }

        .donor-info strong{display:block;font-size:1rem}

        .status-badge{
            padding:6px 12px;
            border-radius:999px;
            font-weight:700;
            color:white;
            font-size:13px;
            text-align:center;
        }

        .status-eligible{
            background:linear-gradient(135deg,#27ae60,#2ecc71);
        }

        .status-not{
            background:linear-gradient(135deg,#e74c3c,#c0392b);
        }

        @media (max-width:800px){
            .stats-container{grid-template-columns:1fr}
            .chart-row{grid-template-columns:1fr}
        }
    </style>
</head>

<body>
<div class="container">

    <!-- Header -->
    <div class="header">
        <a href="/admin/home" class="back">← Back</a>
        <h1>Donor Management — Overview & Analysis</h1>
        <p style="color:#616e7a;margin-top:6px">
            Snapshot of donor registrations and blood request trends
        </p>
    </div>

    <!-- Stats -->
    <div class="stats-container">
        <div class="stat-card">
            <h3>Total Donors</h3>
            <div class="value" th:text="${totalDonors != null ? totalDonors : 0}">0</div>
        </div>

        <div class="stat-card">
            <h3>Eligible Donors</h3>
            <div class="value" th:text="${eligibleDonors != null ? eligibleDonors : 0}">0</div>
        </div>

        <div class="stat-card">
            <h3>Requests by Status</h3>
            <div th:if="${requestsByStatus != null}" th:each="entry : ${requestsByStatus}" style="font-weight:600">
                <span th:text="${entry.key + ' : ' + entry.value}">Pending : 0</span>
            </div>
            <div th:if="${requestsByStatus == null}" style="color:rgba(11,33,66,0.6)">No requests</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-row">
        <div class="card">
            <h3>Donors by Blood Group</h3>
            <canvas id="bloodChart" height="240"></canvas>
        </div>

        <div class="card">
            <h3>Requests by Status</h3>
            <canvas id="statusChart" height="240"></canvas>
        </div>
    </div>

    <!-- Recent Donors -->
    <div class="donor-list">

        <div th:if="${recentDonors == null or #lists.isEmpty(recentDonors)}" class="card">
            No recent donors found.
        </div>

        <div th:each="d : ${recentDonors}" class="donor-card">

            <div class="donor-meta">
                <div class="donor-avatar"
                     th:text="${d.name != null and d.name.length() > 0 ? d.name.substring(0,1) : '?'}">
                    A
                </div>

                <div class="donor-info">
                    <strong th:text="${d.name != null ? d.name : 'Unknown'}">Name</strong>
                    <div style="color:#666;font-size:13px">
                        <span th:text="${d.bloodGroup != null ? d.bloodGroup : 'Unknown'}">A+</span>
                        <span th:text="' • ' + (d.location != null ? d.location : '—')"> • City</span>
                    </div>
                </div>
            </div>

            <div>
                <div
                    th:classappend="${d.id != null and eligibilityMap.containsKey(d.id) and eligibilityMap[d.id]}
                        ? ' status-badge status-eligible'
                        : ' status-badge status-not'"
                    th:text="${d.id != null and eligibilityMap.containsKey(d.id) and eligibilityMap[d.id]}
                        ? 'Eligible'
                        : 'Not Eligible'">
                </div>

                <div style="font-size:12px;color:#888;margin-top:6px;text-align:right"
                     th:text="${d.createdAt != null ? d.createdAt.toLocalDate() : '—'}">
                    —
                </div>
            </div>

        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script th:inline="javascript">
/*<![CDATA[*/
    const donorsByBlood = /*[[${donorsByBlood}]]*/ {};
    const requestsByStatus = /*[[${requestsByStatus}]]*/ {};

    const bloodLabels = Object.keys(donorsByBlood);
    const bloodData = bloodLabels.map(k => donorsByBlood[k]);

    const statusLabels = Object.keys(requestsByStatus);
    const statusData = statusLabels.map(k => requestsByStatus[k]);

    if (bloodLabels.length > 0) {
        new Chart(document.getElementById('bloodChart'), {
            type: 'pie',
            data: {
                labels: bloodLabels,
                datasets: [{
                    data: bloodData,
                    backgroundColor: ['#d32f2f','#1976d2','#fbc02d','#43a047','#8e44ad','#ff7043','#90a4ae']
                }]
            }
        });
    }

    if (statusLabels.length > 0) {
        new Chart(document.getElementById('statusChart'), {
            type: 'bar',
            data: {
                labels: statusLabels,
                datasets: [{
                    label: 'Requests',
                    data: statusData,
                    backgroundColor: '#1976d2'
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } }
            }
        });
    }
/*]]>*/
</script>

</body>
</html>
