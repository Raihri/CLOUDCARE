<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>CloudCare | Blood Donor & Request Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { min-height: 100vh; background: linear-gradient(135deg, #fff6f6 0%, #ffe3e3 100%); color: #333; }

        /* Top Navigation */
        .top-nav { display: flex; justify-content: center; background: #fff; box-shadow: 0 4px 12px rgba(211,47,47,0.12); position: sticky; top: 0; z-index:10; }
        .top-nav button { margin: 0 18px; padding: 14px 28px; border: none; background: none; cursor: pointer; font-weight: 600; color: #666; font-size: 15px; position: relative; transition: all 0.3s; letter-spacing: 0.3px; }
        .top-nav button:hover { color: #d32f2f; }
        .top-nav button.active { color: #d32f2f; font-weight: 700; }
        .top-nav button.active::after { content:""; position: absolute; bottom: 0px; left: 0; right: 0; height: 3px; background: linear-gradient(to right, #c62828, #ef5350); border-radius: 3px 3px 0 0; }

        /* Content Wrapper */
        .content { padding: 30px 20px; max-width: 1300px; margin: auto; }

        /* Ensure sidebar overlays top-nav and content sits to the right */
        .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 99vh; background: #23282d; z-index: 100; box-shadow: 2px 0 8px rgba(0,0,0,0.06); }
        /* .home-section { margin-left: 260px; } */

        /* Section & Cards */
        .section { display:none; }
        .section.active { display:block; }
        .card { background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 25px; transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 8px 24px rgba(211,47,47,0.15); transform: translateY(-2px); }
        h2 { text-align: center; color: #b71c1c; margin-bottom: 25px; letter-spacing: 0.5px; font-size: 26px; }

        /* Add button */
        .add-button { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px; padding: 10px 20px; background: linear-gradient(to right, #d32f2f, #b71c1c); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; transition: all 0.3s; }
        .add-button:hover { background: linear-gradient(to right, #b71c1c, #a11414); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(211,47,47,0.3); }

        /* Filters */
        .filter-container { margin: 20px 0; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center; }
        .filter-input { padding: 10px 14px; min-width: 160px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; transition: all 0.3s; background: #f9f9f9; }
        .filter-input:focus { outline: none; border-color: #d32f2f; background: #fff; box-shadow: 0 0 8px rgba(211,47,47,0.2); }

        /* Table */
        .table-wrapper { overflow-x: auto; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 10px; overflow: hidden; font-size: 13px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-width: 900px; }
        table th, table td { padding: 14px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        table th:last-child, table td:last-child { text-align: center; }
        table th { background: linear-gradient(to right, #d32f2f, #c62828); color: #fff; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; font-size: 12px; }
        table tbody tr:nth-child(odd) { background-color: #fafafa; }
        table tbody tr:hover { background: linear-gradient(to right, #fffbfb 0%, #fff3e0 100%); transition: 0.2s ease; box-shadow: inset 2px 0 0 #d32f2f; }
        table td { vertical-align: middle; }
        table td:last-child { min-width: 180px; }

        /* Buttons */
        .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; margin: 4px; font-weight: 600; font-size: 13px; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(to right, #d32f2f, #b71c1c); color: #fff; }
        .btn-primary:hover { background: linear-gradient(to right, #b71c1c, #a11414); box-shadow: 0 3px 10px rgba(211,47,47,0.3); }
        .btn-success { background: #43a047; color: #fff; }
        .btn-success:hover { background: #2e7d32; box-shadow: 0 3px 10px rgba(76,175,80,0.3); }
        .btn-warning { background: #fbc02d; color: #333; }
        .btn-warning:hover { background: #f9a825; box-shadow: 0 3px 10px rgba(251,192,45,0.3); }
        .btn-danger { background: #e53935; color: #fff; }
        .btn-danger:hover { background: #c62828; box-shadow: 0 3px 10px rgba(229,57,53,0.3); }
        .btn-secondary { background: #b0bec5; color: #fff; }
        .btn-secondary:hover { background: #90a4ae; box-shadow: 0 3px 10px rgba(176,190,197,0.3); }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 1000; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; position: relative; transform: translateY(-40px); transition: all 0.3s ease-in-out; box-shadow: 0 12px 36px rgba(0,0,0,0.25); }
        .modal.show .modal-content { transform: translateY(0); }
        .close { position: absolute; top: 18px; right: 22px; cursor: pointer; font-size: 26px; color: #999; transition: color 0.2s; font-weight: 300; line-height: 1; }
        .close:hover { color: #c62828; }
        .modal h3 { color: #b71c1c; margin-bottom: 18px; font-size: 20px; }

        /* Modal form inputs */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: 'Poppins', sans-serif; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #d32f2f; box-shadow: 0 0 8px rgba(211,47,47,0.2); background: #fff; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .modal-buttons .save-btn { background: linear-gradient(to right, #d32f2f, #b71c1c); color: #fff; }
        .modal-buttons .save-btn:hover { background: linear-gradient(to right, #b71c1c, #a11414); box-shadow: 0 3px 10px rgba(211,47,47,0.3); }
        .modal-buttons .cancel-btn { background: #b0bec5; color: #fff; }
        .modal-buttons .cancel-btn:hover { background: #90a4ae; }

        /* Admin stats & charts */
        .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 18px; margin-top: 20px; }
        .stat-card { 
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%); 
            border-left: 5px solid #d32f2f; 
            padding: 24px; 
            border-radius: 10px; 
            box-shadow: 0 2px 12px rgba(211,47,47,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before { content: ""; position: absolute; top: -50%; right: -50%; width: 200px; height: 200px; background: rgba(211,47,47,0.03); border-radius: 50%; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(211,47,47,0.12); }
        .stat-card h4 { color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 10px; font-weight: 600; }
        .stat-card .number { font-size: 36px; font-weight: 800; color: #d32f2f; letter-spacing: -1px; }
        .stat-card .icon { display: inline-block; font-size: 24px; margin-bottom: 8px; }

        /* Admin Dashboard Chart Container */
        .admin-chart-container { 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            padding: 24px; 
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .admin-chart-container:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
        .admin-chart-container h3 { color: #b71c1c; margin-bottom: 16px; font-size: 16px; font-weight: 700; letter-spacing: 0.3px; display: flex; align-items: center; gap: 8px; }

        /* Admin Bottom Section */
        .admin-bottom { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-top: 20px;
        }
        .admin-bottom-item {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border-top: 3px solid #d32f2f;
            transition: all 0.3s ease;
        }
        .admin-bottom-item:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .admin-bottom-item h5 { color: #b71c1c; margin-bottom: 12px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; display: flex; align-items: center; gap: 6px; }

        /* Urgent Table Styling - ENHANCED */
        .urgent-table-container { 
            border: 1px solid #e8e8e8; 
            border-radius: 8px; 
            overflow: hidden;
            background: #fafafa;
        }
        .urgent-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 12px;
            background: #fff;
        }
        .urgent-table thead { 
            background: linear-gradient(to right, #fcf9f9 0%, #dc223e 100%);
            border-bottom: 2px solid #d32f2f;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .urgent-table th { 
            padding: 14px 10px; 
            text-align: left; 
            font-weight: 700; 
            font-size: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            background: linear-gradient(to right, #d81d1d 0%, #d4334b 100%);
        }
        .urgent-table td { 
            padding: 10px; 
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        .urgent-table tbody tr { 
            transition: all 0.2s ease;
        }
        .urgent-table tbody tr:hover { 
            background: linear-gradient(to right, #fffbfb 0%, #fff5e6 100%);
            border-left: 3px solid #d32f2f;
            padding-left: 7px;
            box-shadow: inset 0 2px 4px rgba(211,47,47,0.05);
        }
        .urgent-table tbody tr:last-child td { border-bottom: none; }
        
        /* Urgent Table Data Formatting */
        .urgent-req-id { font-weight: 700; color: #d32f2f; min-width: 30px; }
        .urgent-req-name { font-weight: 600; color: #333; }
        .urgent-req-blood { 
            font-weight: 700; 
            background: #fff3f3; 
            padding: 2px 6px; 
            border-radius: 4px; 
            display: inline-block;
            text-align: center;
            min-width: 40px;
            color: #d32f2f;
        }
        .urgent-req-date { color: #666; font-size: 11px; }
        .urgent-req-btn {
            background: linear-gradient(to right, #d32f2f, #c62828);
            color: #fff;
            border: none;
            padding: 5px 10px;
            font-size: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 6px rgba(211,47,47,0.2);
        }
        .urgent-req-btn:hover {
            background: linear-gradient(to right, #b71c1c, #a11414);
            box-shadow: 0 4px 10px rgba(211,47,47,0.4);
            transform: translateY(-1px);
        }
        .urgent-req-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(211,47,47,0.3);
        }

        /* Blood Group List Styling */
        .blood-group-list { font-size: 12px; color: #555; line-height: 2.2; }
        .blood-group-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f5f5f5; }
        .blood-group-item strong { color: #d32f2f; font-weight: 700; }
        .blood-group-item span { background: #fff3f3; padding: 2px 8px; border-radius: 4px; min-width: 30px; text-align: center; }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .admin-bottom { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .admin-stats { grid-template-columns: repeat(2, 1fr); }
            .stat-card { padding: 16px; }
            .stat-card .number { font-size: 28px; }
        }
        @media (max-width: 640px) {
            .admin-stats { grid-template-columns: 1fr; }
            .admin-chart-container { padding: 16px; }
        }
                .urgent-table button { padding: 4px 8px; font-size: 11px; }

        
                /* Responsive: stack on mobile */
                @media (max-width: 1024px) {
                    .chart-row { grid-template-columns: 1fr; }
                    .admin-stats { grid-template-columns: repeat(2, 1fr); }
                }
                @media (max-width: 640px) {
                    .admin-stats { grid-template-columns: 1fr; }
                    .chart-col h4 { font-size: 13px; }
                    #trendChart { max-height: 160px !important; }
                }

    </style>
</head>
<body>

<!-- SIDEBAR: include shared fragment for consistent navigation -->
<div class="sidebar">
    <div class="logo-details">
        <img th:src="@{/image/logo.png}" alt="CloudCare Logo"/>

        <span class="logo_name">CloudCare</span>
    </div>
    <ul class="nav-links">
        
        <li>
            <a th:href="@{/patient/dashboard}">
                <i class="bx bxs-user"></i>
                <span class="link_name">Patient Profile</span>
            </a>
            <ul class="sub-menu blank">
                <li><a class="link_name" href="patient">Patient Profile</a></li>
            </ul>
        </li>

          <li>
            <a th:href="@{/patient/dataEntry}">
                <i class="bx bxs-edit"></i>
                <span class="link_name">Edit Profile</span>
            </a>
            <ul class="sub-menu blank">
                <li><a class="link_name" href="patient">Edit Profile</a></li>
            </ul>
        </li>

         <li>
            <a th:href="@{/patient/doctor_list}">
                <i class="bx bx-menu"></i>
                <span class="link_name">Doctors List</span>
            </a>
            <ul class="sub-menu blank">
                <li><a class="link_name" href="patient">Doctors List</a></li>
            </ul>
        </li>


        <li class="active">
            <a th:href="@{/patient/donor}">
                <i class='bx bxs-droplet'></i>
                <span class="link_name">Find Donor</span>
            </a>
            <ul class="sub-menu blank">
                <li><a class="link_name" href="donor">Find Donor</a></li>
            </ul>
        </li>

        <li>
            <a th:href="@{/patient/aichat}">
                <i class='bx bxs-chat'></i>
                <span class="link_name">CloudCare AI</span>
            </a>
            <ul class="sub-menu blank">
                <li><a class="link_name" href="/patient/aichat">CloudCare AI</a></li>
            </ul>
        </li>
        <li>
            <a th:href="@{/patient/quiz_index1}">
                <i class='bx bxs-brain'></i>
                <span class="link_name">Mental Health Quiz</span>
            </a>
            <ul class="sub-menu blank">
                <li><a class="link_name" href="/patient/quiz_index1">Mental Health Quiz</a></li>
            </ul>
        </li>
         <li>
            <a th:href="@{/patient/appointments}">
                <i class='bx bx-phone'></i>
                <span class="link_name">Appointments</span>
            </a>
            <ul class="sub-menu blank">
                <li><a class="link_name" href="appointments">Appointments</a></li>
            </ul>
        </li>

        <li>
            <a th:href="@{/patient/tasks}">
                <i class='bx bx-run'></i>
                <span class="link_name">Daily Tasks</span>
            </a>
            <ul class="sub-menu blank">
                <li><a class="link_name" href="/patient/tasks">Daily Tasks</a></li>
            </ul>
        </li>
      

       
        <li>
            <!-- Patient Content Here -->
            <div class="profile-details" th:if="${patient != null}">
                <a th:href="@{/patient/dashboard}"
                   style="display: flex; align-items: center; text-decoration: none; width: 100%;">
                    <div class="profile-content">
                        <!-- show patient image -->
                        <img th:if="${patient != null and patient.user != null and patient.user.photoUrl != null}"
                             th:src="${patient.user.photoUrl}"
                             alt="profileImg" style="height: 52px; width: 52px; object-fit: cover; border-radius: 16px;">
                        <img th:if="${patient.user == null or patient.user.photoUrl == null}"
                             src="https://media.istockphoto.com/id/1208175274/vector/avatar-vector-icon-simple-element-illustrationavatar-vector-icon-material-concept-vector.jpg?s=612x612&w=0&k=20&c=t4aK_TKnYaGQcPAC5Zyh46qqAtuoPcb-mjtQax3_9Xc="
                             alt="defaultProfile" style="height: 52px; width: 52px; object-fit: cover; border-radius: 16px;">

                        <div class="name-job">
                            <div class="profile_name" th:text="${patient.user != null and patient.user.name != null ? patient.user.name : 'Patient'}">Patient</div>
                            <div class="job" th:text="'Patient ID: ' + (${patient.id != null ? patient.id : 'N/A'})">Patient ID</div>
                        </div>
                    </div>
                </a>
            </div>
        </li>
    </ul>
</div>

<!-- MAIN CONTENT -->


<section class="home-section">
    <div class="home-header">
        <i class='bx bx-menu' id="sidebarToggle"></i>
        <h1>Blood Donor & Request Dashboard</h1>
    </div>

    <div class="top-nav">
        <button data-section="donors" class="active">Blood Donor</button>
        <button data-section="requests">Request Blood</button>
        <button data-section="admin">Dashboard</button>
    </div>

    <div class="content">
        <!-- Donors Section -->
        <section id="donors" class="section active card">
            <h2>üíâ Blood Donors Registry</h2>
            <a th:href="@{/patient/donor-form}" class="add-button">
                <i class='bx bxs-plus-circle'></i> Add New Donor
            </a>

            <div class="filter-container">
                <input type="text" placeholder="üîç Filter by Name" id="donorFilterName" class="filter-input" oninput="renderDonors()">
                <input type="text" placeholder="üîç Filter by Blood Group" id="donorFilterBlood" class="filter-input" oninput="renderDonors()">
                <select id="donorFilterStatus" class="filter-input" onchange="renderDonors()">
                    <option value="">üìä All Status</option>
                    <option>Cannot Donate
                             (Disease)</option>
                    <option>Cannot Donate
                             (Recent)</option>
                    <option>Eligible</option>
                    <option>Non-Eligible</option>
                </select>
            </div>
            <div class="table-wrapper">
                <table id="donorTable">
                    <thead>
                        <tr>
                            <th>üë§ Name</th><th>‚úâÔ∏è Email</th><th>üéÇ Age</th><th>‚öß Gender</th><th>ü©∏ Blood Group</th><th>üìû Contact</th>
                            <th>üìÖ Last Donated</th><th>‚ú® Eligibility</th><th>‚öôÔ∏è Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Requests Section -->
        <section id="requests" class="section card">
            <h2>ü©π Blood Requests</h2>
            <a th:href="@{/patient/request-form}" class="add-button">
                <i class='bx bxs-plus-circle'></i> Add New Request
            </a>
            <div class="filter-container">
                <input type="text" placeholder="üîç Filter by Name" id="requestFilterName" class="filter-input" oninput="renderRequests()">
                <input type="text" placeholder="üîç Filter by Blood Group" id="requestFilterBlood" class="filter-input" oninput="renderRequests()">
                <select id="requestFilterStatus" class="filter-input" onchange="renderRequests()">
                    <option value="">üìä All Status</option>
                    <option>Pending</option>
                    <option>Matched</option>
        
                </select>
            </div>
            <div class="table-wrapper">
                <table id="requestTable">
                    <thead>
                        <tr><th>üë§ Name</th><th>‚úâÔ∏è Email</th><th>ü©∏ Blood Group</th><th>üì¶ Units</th><th>‚úì Status</th><th>‚öôÔ∏è Actions</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" class="section card">
            <h2>üìä Dashboard</h2>
            
            <!-- Stats Cards -->
            <div class="admin-stats">
                <div class="stat-card">
                    <div class="icon">üíâ</div>
                    <h4>Total Donors</h4>
                    <div class="number" id="adminTotalDonors">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚úÖ</div>
                    <h4>Eligible Donors</h4>
                    <div class="number" id="adminEligibleDonors">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚è≥</div>
                    <h4>Pending Requests</h4>
                    <div class="number" id="adminPendingRequests">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚úì</div>
                    <h4>Matched Requests</h4>
                    <div class="number" id="adminMatchedRequests">0</div>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="admin-chart-container">
                <h3>üìà Trends Analysis (Last 14 Days)</h3>
                <canvas id="trendChart" width="400" height="260" style="max-height: 260px;"></canvas>

                <!-- Bottom Section: Urgent + Blood Group -->
                <div class="admin-bottom">
                    <!-- Urgent Requests -->
                    <div class="admin-bottom-item">
                        <h5>üö® Urgent Requests (‚â§3 days)</h5>
                        <div class="urgent-table-container" style="max-height: 280px; overflow-y: auto;">
                            <table id="urgentTable" class="urgent-table">
                                <thead>
                                    <tr>
                                        <th style="width: 8%;">ID</th>
                                        <th style="width: 35%;">Patient Name</th>
                                        <th style="width: 15%;">Blood</th>
                                        <th style="width: 25%;">Required Date</th>
                                        <th style="width: 17%; text-align: center;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="urgentBody">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: #999; padding: 20px 8px; font-size: 12px;">üì≠ Loading‚Ä¶</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- By Blood Group -->
                    <div class="admin-bottom-item">
                        <h5>ü©∏ Donors by Blood Group</h5>
                        <div id="adminBloodList" class="blood-group-list">Loading‚Ä¶</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Donor modal removed: use full-page donor form at /patient/donor-form -->

    <!-- Request Modal removed: request creation/edit now uses full-page `request_form` -->

    <!-- Disease Modal -->
    <div class="modal" id="diseaseModal">
        <div class="modal-content">
            <span class="close" onclick="closeDiseaseModal()">&times;</span>
            <h3>üè• Donor Medical History</h3>
            <ul id="diseaseList" style="max-height: 250px; overflow-y: auto; padding-left: 20px; line-height: 1.8;"></ul>
        </div>
    </div>

    <!-- Inline Edit Donor Modal -->
    <div class="modal" id="editDonorModal">
        <div class="modal-content" style="max-width:640px; max-height:90vh; overflow-y:auto;">
            <span class="close" onclick="closeEditDonorModal()">&times;</span>
            <div style="background: linear-gradient(135deg,#d32f2f,#b71c1c); color:#fff; margin:-30px -30px 20px -30px; padding:20px 25px; border-radius:10px 10px 0 0; text-align:center;">
                <i class='bx bxs-user-detail' style="font-size:26px; display:block; margin-bottom:8px;"></i>
                <h3 style="margin:0; font-size:20px;">‚úèÔ∏è Edit Donor Profile</h3>
                <p style="margin:6px 0 0 0; opacity:0.92; font-size:13px;">Update donor details quickly</p>
            </div>

            <form id="editDonorForm" style="padding:18px;">
                <input type="hidden" id="editDonorId">

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editDonorName" placeholder="Full name" required>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Age</label>
                        <input type="number" id="editDonorAge" min="18" max="100">
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="editDonorGender">
                            <option value="">Select</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Blood Group</label>
                    <select id="editDonorBlood">
                        <option value="">Select</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Contact</label>
                    <input type="text" id="editDonorContact" placeholder="Mobile number">
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editDonorEmail" placeholder="email@example.com">
                </div>

                <div class="form-group">
                    <label>Last Donated</label>
                    <input type="date" id="editDonorLastDonated">
                </div>

                <div class="modal-buttons" style="margin-top:14px;">
                    <button type="button" class="cancel-btn" onclick="closeEditDonorModal()">Cancel</button>
                    <button type="button" class="save-btn" onclick="saveEditedDonor()">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Inline Edit Request Modal -->
    <div class="modal" id="editRequestModal">
        <div class="modal-content" style="max-width:620px; max-height:90vh; overflow-y:auto;">
            <span class="close" onclick="closeEditRequestModal()">&times;</span>
            <div style="background: linear-gradient(135deg,#d32f2f,#b71c1c); color:#fff; margin:-30px -30px 20px -30px; padding:20px 25px; border-radius:10px 10px 0 0; text-align:center;">
                <i class='bx bxs-edit' style="font-size:26px; display:block; margin-bottom:8px;"></i>
                <h3 style="margin:0; font-size:20px;">‚úèÔ∏è Edit Blood Request</h3>
                <p style="margin:6px 0 0 0; opacity:0.92; font-size:13px;">Update requester details inline</p>
            </div>

            <form id="editRequestForm" style="padding:18px;">
                <input type="hidden" id="editRequestId">

                <div class="form-group">
                    <label>Patient Name</label>
                    <input type="text" id="editReqName" placeholder="Full name" required>
                </div>

                <div class="form-group">
                    <label>Email (read-only)</label>
                    <input type="email" id="editReqEmail" readonly placeholder="email@example.com" style="background:#f5f5f5; color:#666;">
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Blood Group</label>
                        <select id="editReqBlood" required>
                            <option value="">Select</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Units Needed</label>
                        <input type="number" id="editReqUnits" min="1" max="10" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Required Date</label>
                    <input type="date" id="editReqDate">
                </div>

                <div class="form-group">
                    <label>Medical Reason (optional)</label>
                    <textarea id="editReqReason" style="min-height:80px;"></textarea>
                </div>

                <div class="modal-buttons" style="margin-top:14px;">
                    <button type="button" class="cancel-btn" onclick="closeEditRequestModal()">Cancel</button>
                    <button type="button" class="save-btn" onclick="saveEditedRequest()">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

<script>
    // Fixed Tab Switching Functionality
    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.querySelector(".sidebar");
        const toggleBtn = document.getElementById("sidebarToggle");
        
        // Sidebar toggle
        if (sidebar && toggleBtn) {
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                sidebar.classList.add('close');
            }
            
            toggleBtn.addEventListener("click", () => {
                sidebar.classList.toggle("close");
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('close'));
            });
        }
        
        // Tab switching functionality - FIXED
        function switchTab(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.top-nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Find and activate the corresponding button
            const targetButton = document.querySelector(`.top-nav button[data-section="${sectionId}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }
        
        // Add click event listeners to tab buttons
        document.querySelectorAll('.top-nav button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = button.getAttribute('data-section');
                switchTab(sectionId);
            });
        });
        
        // Initialize with first tab active
        switchTab('donors');
    });
</script>

<script>
    // Search Filter
    function searchTable() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#doctorsTable tbody tr");

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(input) ? "" : "none";
        });
    }
</script>

    <script>
        // API endpoints
        const donorAPI = '/api/donor';
        const requestAPI = '/api/request';

        const diseaseModal = document.getElementById('diseaseModal');
        const diseaseList = document.getElementById('diseaseList');

        // Email selection handling for donor form
        (function setupEmailSelection() {
            const donorForm = document.getElementById('donorForm');
            if (!donorForm) return;
            const loginRadio = donorForm.querySelector('input[name="emailChoice"][value="login"]');
            const customRadio = donorForm.querySelector('input[name="emailChoice"][value="custom"]');
            const customEmailInput = donorForm.querySelector('input[name="customEmail"]');
            const selectedEmail = donorForm.querySelector('#selectedEmail');

            function updateSelected() {
                if (customRadio && customRadio.checked) {
                    selectedEmail.value = customEmailInput.value || '';
                } else {
                    selectedEmail.value = document.getElementById('loginEmailDisplay') ? document.getElementById('loginEmailDisplay').textContent.trim() : '';
                }
            }

            if (loginRadio) loginRadio.addEventListener('change', updateSelected);
            if (customRadio) customRadio.addEventListener('change', updateSelected);
            if (customEmailInput) customEmailInput.addEventListener('input', () => {
                if (customRadio && customRadio.checked) updateSelected();
            });
        })();

        // Email selection handling for request form removed (full-page `request_form` handles it)

        function closeDiseaseModal() { diseaseModal.classList.remove('show'); }

        async function loadDonors() {
            // Add cache-busting query parameter to force fresh data from server
            const res = await fetch(`${donorAPI}/list?t=${Date.now()}`, {
                headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
            });
            const data = await res.json();
            return data.donors || data.data || data;
        }

        // Normalize blood group field from different API shapes
        function getBloodValue(obj) {
            if (!obj) return '‚Äî';
            return obj.bloodGroup || obj.blood_group || obj.bloodType || obj.blood || '‚Äî';
        }

        async function saveDonorBackend(donor) {
            try {
                if (donor.id) {
                    const res = await fetch(`${donorAPI}/update/${donor.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(donor)
                    });
                    const result = await res.json();
                    if (result.success) alert('Donor updated successfully');
                    else if (result.error) alert('Error: ' + result.error);
                    else alert('Error: ' + (result.message || 'Unknown error'));
                } else {
                    const res = await fetch(`${donorAPI}/create`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(donor)
                    });
                    const result = await res.json();
                    if (result.success) alert('Donor added successfully');
                    else if (result.error) alert('Error: ' + result.error);
                    else alert('Error: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
                console.error(error);
            }
        }

        async function deleteDonorBackend(id) {
            try {
                const res = await fetch(`${donorAPI}/delete/${id}`, {method: 'DELETE'});
                const result = await res.json();
                if (result.success) alert('Donor deleted successfully');
                else if (result.error) alert('Error: ' + result.error);
                else alert('Error: ' + (result.message || 'Unknown error'));
            } catch (error) {
                alert('Network error: ' + error.message);
                console.error(error);
            }
        }

        async function loadRequests() {
            const res = await fetch(`${requestAPI}/list`);
            const data = await res.json();
            return data.data || data;
        }

        async function saveRequestBackend(request) {
            try {
                if (request.id) {
                    const res = await fetch(`${requestAPI}/update/${request.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(request)
                    });
                    const result = await res.json();
                    if (!result.success) throw new Error(result.message || result.error || 'Unknown error');
                } else {
                    const res = await fetch(`${requestAPI}/create`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(request)
                    });
                    const result = await res.json();
                    if (!result.success) throw new Error(result.message || result.error || 'Unknown error');
                }
            } catch (err) {
                alert('Request save failed: ' + err.message);
                console.error(err);
                throw err;
            }
        }

        async function deleteRequestBackend(id) {
            const res = await fetch(`${requestAPI}/delete/${id}`, {method: 'DELETE'});
            const result = await res.json();
            if (!result.success) alert('Delete failed: ' + (result.message || result.error || 'Unknown'));
        }

        function computeEligibility(lastDonated, diseases) {
            const today = new Date();
            const lastDate = lastDonated ? new Date(lastDonated) : new Date('2000-01-01');
            const monthsDiff = (today.getFullYear() - lastDate.getFullYear()) * 12 + (today.getMonth() - lastDate.getMonth());
            if (monthsDiff < 3) return "Cannot Donate (Recent)";
            if (diseases.some(d => parseInt(d.level) >= 2)) return "Cannot Donate (Disease)";
            return "Eligible";
        }

        const donorTableBody = document.querySelector('#donorTable tbody');
        async function renderDonors() {
            const donors = await loadDonors();
            donorTableBody.innerHTML = '';

            donors.forEach(d => {
                const blood = getBloodValue(d);
                const eligibility = computeEligibility(d.lastDonated, d.diseases || []);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${d.name || '‚Äî'}</strong></td>
                    <td><a href="mailto:${d.email || '#'}" style="color:#d32f2f;text-decoration:none;">${d.email || '‚Äî'}</a></td>
                    <td>${d.age || '‚Äî'}</td>
                    <td>${d.gender || '‚Äî'}</td>
                    <td><strong>${blood}</strong></td>
                    <td>${d.contact || '‚Äî'}</td>
                    <td>${d.lastDonated ? d.lastDonated.substring(0, 10) : '‚Äî'}</td>
                    <td>${eligibility}</td>
                    <td style="text-align: center;">
                        <button class="btn btn-warning edit-donor" title="Edit donor" style="padding: 6px 10px;">‚úèÔ∏è</button>
                        <button class="btn btn-danger delete-donor" title="Delete donor" style="padding: 6px 10px;">üóëÔ∏è</button>
                        <button class="btn btn-primary view-diseases" title="View medical history" style="padding: 6px 10px;">üìã</button>
                    </td>
                `;
                donorTableBody.appendChild(row);
                // expose id on the row for debugging/diagnostics
                if (d && d.id !== undefined) row.dataset.id = d.id;

                row.querySelector('.edit-donor').addEventListener('click', () => editDonor(d.id));
                row.querySelector('.delete-donor').addEventListener('click', () => deleteDonor(d.id));
                row.querySelector('.view-diseases').addEventListener('click', () => viewDiseases(d.id));
            });

            filterDonors();
            updateAdminCounts();
        }

        const requestTableBody = document.querySelector('#requestTable tbody');
        async function renderRequests() {
            const requests = await loadRequests();
            requestTableBody.innerHTML = '';

            requests.forEach(r => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${r.name || '‚Äî'}</strong></td>
                    <td><a href="mailto:${r.email || '#'}" style="color:#d32f2f;text-decoration:none;">${r.email || '‚Äî'}</a></td>
                    <td><strong>${getBloodValue(r)}</strong></td>
                    <td>${r.units || 0} units</td>
                    <td><span class="status-${r.status}">${r.status || 'Pending'}</span></td>
                    <td style="text-align: center;">
                        <button class="btn btn-warning edit-request" title="Edit request" style="padding: 6px 10px;">‚úèÔ∏è</button>
                        <button class="btn btn-danger delete-request" title="Delete request" style="padding: 6px 10px;">üóëÔ∏è</button>
                    </td>
                `;
                requestTableBody.appendChild(row);

                row.querySelector('.edit-request').addEventListener('click', () => editRequest(r.id));
                row.querySelector('.delete-request').addEventListener('click', () => deleteRequest(r.id));
            });

            filterRequests();
            updateAdminCounts();
        }

        // Donor modal submit handler removed; full-page donor form handles save


        // Request modal submit handler removed; use full-page `request_form` instead

        async function editDonor(id) {
            // Inline edit modal for donor
            if (!id && id !== 0) {
                alert('Donor ID is missing. Cannot open edit form.');
                return;
            }

            try {
                const res = await fetch(`${donorAPI}/get/${id}`);
                if (!res.ok) {
                    const txt = await res.text().catch(() => '');
                    throw new Error(`Server returned ${res.status} ${txt}`);
                }
                const data = await res.json().catch(() => null);
                const donor = (data && (data.data || data.donor)) || data;
                if (!donor || !donor.id) {
                    alert('Donor not found');
                    return;
                }

                // Prefill modal fields
                document.getElementById('editDonorId').value = donor.id;
                document.getElementById('editDonorName').value = donor.name || '';
                document.getElementById('editDonorAge').value = donor.age || '';
                // normalize gender values if backend uses different strings
                const g = donor.gender || '';
                document.getElementById('editDonorGender').value = (g === 'Male' || g === 'M') ? 'M' : (g === 'Female' || g === 'F') ? 'F' : (g || '');
                const bloodVal = donor.bloodGroup || donor.blood_group || donor.bloodType || donor.blood || '';
                document.getElementById('editDonorBlood').value = bloodVal;
                document.getElementById('editDonorContact').value = donor.contact || '';
                document.getElementById('editDonorEmail').value = donor.email || '';
                document.getElementById('editDonorLastDonated').value = donor.lastDonated ? donor.lastDonated.toString().substring(0,10) : (donor.last_donated ? donor.last_donated.toString().substring(0,10) : '');

                document.getElementById('editDonorModal').classList.add('show');
            } catch (err) {
                console.error('Failed to load donor for edit:', err);
                alert('Failed to load donor: ' + (err.message || err));
            }
        }

        function closeEditDonorModal() { document.getElementById('editDonorModal').classList.remove('show'); }

        async function saveEditedDonor() {
            const id = document.getElementById('editDonorId').value;
            if (!id) { alert('Missing donor id'); return; }

            const payload = {
                id: parseInt(id),
                name: document.getElementById('editDonorName').value.trim(),
                age: parseInt(document.getElementById('editDonorAge').value) || 0,
                gender: document.getElementById('editDonorGender').value || null,
                bloodGroup: document.getElementById('editDonorBlood').value || null,
                contact: document.getElementById('editDonorContact').value.trim() || null,
                email: document.getElementById('editDonorEmail').value.trim() || null,
                lastDonated: document.getElementById('editDonorLastDonated').value || null
            };

            try {
                const res = await fetch(`${donorAPI}/update/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify(payload)
                });

                const text = await res.text().catch(() => '');
                let json = null; try { if (text) json = JSON.parse(text); } catch(e) {}
                if (!res.ok) {
                    const msg = (json && (json.error || json.message)) || text || `Status ${res.status}`;
                    throw new Error(msg);
                }

                const success = (json && json.success === true) || res.ok;
                if (!success) throw new Error((json && (json.error || json.message)) || 'Unknown error');

                // If backend returns updated donor use that, otherwise fall back to payload
                const updated = (json && (json.data || json.donor)) || json || payload;
                const updatedBlood = (updated && (updated.bloodGroup || updated.blood_group || updated.bloodType || updated.blood)) || payload.bloodGroup;
                localStorage.setItem('donorUpdatedId', id);
                if (updatedBlood) localStorage.setItem('donorUpdatedBlood', updatedBlood);

                closeEditDonorModal();
                alert('‚úÖ Donor updated');
                await renderDonors();
                applyPendingDonorUpdate();
            } catch (err) {
                console.error('Save donor failed:', err);
                alert('Failed to save donor: ' + (err.message || err));
            }
        }

        async function deleteDonor(id) {
            const confirmDelete = confirm("‚ö†Ô∏è Are you sure? This action cannot be undone.\n\nDelete this donor record?");
            if (confirmDelete) {
                try {
                    await deleteDonorBackend(id);
                    alert('‚úì Donor deleted successfully');
                    renderDonors();
                } catch (err) {
                    alert('‚úó Error deleting donor: ' + err.message);
                }
            }
        }

        function closeEditRequestModal() { document.getElementById('editRequestModal').classList.remove('show'); }

        async function editRequest(id) {
            if (!id && id !== 0) {
                alert('Request id is missing. Cannot open edit form.');
                return;
            }

            try {
                const res = await fetch(`${requestAPI}/get/${id}`);
                if (!res.ok) {
                    const txt = await res.text().catch(() => '');
                    throw new Error(`Server returned ${res.status} ${txt}`);
                }
                const data = await res.json().catch(() => null);
                const req = (data && (data.data || data.request)) || data;
                if (!req || !req.id) {
                    alert('Request not found');
                    return;
                }

                // Prefill modal fields
                document.getElementById('editRequestId').value = req.id;
                document.getElementById('editReqName').value = req.name || '';
                document.getElementById('editReqEmail').value = req.email || '';
                document.getElementById('editReqBlood').value = req.bloodGroup || '';
                document.getElementById('editReqUnits').value = req.units || 1;
                const dateVal = req.requiredDate || req.required_date || req.date || '';
                document.getElementById('editReqDate').value = dateVal ? dateVal.toString().substring(0,10) : '';
                document.getElementById('editReqReason').value = req.medicalReason || req.medical_reason || req.reason || '';

                document.getElementById('editRequestModal').classList.add('show');
            } catch (err) {
                console.error('Failed to load request for edit:', err);
                alert('Failed to load request: ' + (err.message || err));
            }
        }

        async function saveEditedRequest() {
            const requestId = document.getElementById('editRequestId').value;
            if (!requestId) { alert('Missing request id'); return; }

            const payload = {
                name: document.getElementById('editReqName').value,
                email: document.getElementById('editReqEmail').value,
                bloodGroup: document.getElementById('editReqBlood').value,
                units: parseInt(document.getElementById('editReqUnits').value) || 1,
                requiredDate: document.getElementById('editReqDate').value,
                medicalReason: document.getElementById('editReqReason').value || ''
            };

            try {
                const res = await fetch(`${requestAPI}/update/${requestId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify(payload)
                });

                const text = await res.text().catch(() => '');
                let json = null; try { if (text) json = JSON.parse(text); } catch(e) {}

                if (!res.ok) {
                    const msg = (json && (json.error || json.message)) || text || `Status ${res.status}`;
                    throw new Error(msg);
                }

                // Consider success when backend returns { success: true } or http 200
                const success = (json && (json.success === true || json.updated === true)) || res.ok;
                if (!success) throw new Error((json && (json.error || json.message)) || 'Unknown error');

                closeEditRequestModal();
                alert('‚úÖ Request updated');
                renderRequests();
            } catch (err) {
                console.error('Save failed:', err);
                alert('Failed to save: ' + (err.message || err));
            }
        }

        async function deleteRequest(id) {
            const confirmDelete = confirm("‚ö†Ô∏è Are you sure? This action cannot be undone.\n\nDelete this request?");
            if (confirmDelete) {
                try {
                    await deleteRequestBackend(id);
                    alert('‚úì Request deleted successfully');
                    renderRequests();
                } catch (err) {
                    alert('‚úó Error deleting request: ' + err.message);
                }
            }
        }

        async function viewDiseases(id) {
            const donors = await loadDonors();
            const d = donors.find(x => x.id == id);

            diseaseList.innerHTML = '';
            (d.diseases || []).forEach(ds => {
                const li = document.createElement('li');
                li.textContent = `${ds.name} (Danger Level: ${ds.level})`;
                diseaseList.appendChild(li);
            });

            diseaseModal.classList.add('show');
        }

        function filterDonors() {
            const nameFilter = donorFilterName.value.toLowerCase();
            const bloodFilter = donorFilterBlood.value.toLowerCase();
            const eligibilityFilter = donorFilterStatus.value;

            Array.from(donorTableBody.rows).forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const blood = row.cells[4].textContent.toLowerCase();
                const eligibility = row.cells[7].textContent;

                row.style.display =
                    name.includes(nameFilter) &&
                    blood.includes(bloodFilter) &&
                    (eligibilityFilter === "" || eligibility === eligibilityFilter)
                        ? ""
                        : "none";
            });
        }

        function filterRequests() {
            const nameFilter = requestFilterName.value.toLowerCase();
            const bloodFilter = requestFilterBlood.value.toLowerCase();
            const statusFilter = requestFilterStatus.value;

            Array.from(requestTableBody.rows).forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const blood = row.cells[2].textContent.toLowerCase();
                const status = row.cells[4].textContent;

                row.style.display =
                    name.includes(nameFilter) &&
                    blood.includes(bloodFilter) &&
                    (statusFilter === "" || status === statusFilter)
                        ? ""
                        : "none";
            });
        }

        async function updateAdminCounts() {
            const donors = await loadDonors();
            const requests = await loadRequests();
            document.getElementById('totalDonors').textContent = donors.length;
            document.getElementById('totalRequests').textContent = requests.length;
        }

        function applyPendingDonorUpdate() {
            try {
                const updatedId = localStorage.getItem('donorUpdatedId');
                const updatedBlood = localStorage.getItem('donorUpdatedBlood');
                if (!updatedId) return;

                const row = Array.from(document.querySelectorAll('#donorTable tbody tr')).find(r => r.dataset.id == updatedId);
                if (row && updatedBlood) {
                    const cell = row.cells[4];
                    if (cell) cell.innerHTML = `<strong>${updatedBlood}</strong>`;
                }

                localStorage.removeItem('donorUpdatedId');
                localStorage.removeItem('donorUpdatedBlood');
            } catch (e) {
                console.warn('applyPendingDonorUpdate failed', e);
            }
        }

        // Refresh donors when the page/tab becomes visible again and apply any pending update
        window.addEventListener('focus', async () => { await renderDonors(); applyPendingDonorUpdate(); });
        document.addEventListener('visibilitychange', async () => { if (document.visibilityState === 'visible') { await renderDonors(); applyPendingDonorUpdate(); } });

        // initial render and try to apply any pending update shortly after
        (async function initDashboard() {
            await renderDonors();
            await renderRequests();
            setTimeout(applyPendingDonorUpdate, 250);
            loadAdminSummary();
        })();

        // ===== ADMIN DASHBOARD FUNCTIONS =====
        let trendChart = null;

        async function loadAdminSummary() {
            try {
                const res = await fetch('/patient/donor-admin/api/summary');
                const json = await res.json();
                if (json && json.success) {
                    document.getElementById('adminTotalDonors').textContent = json.totalDonors;
                    document.getElementById('adminEligibleDonors').textContent = json.eligibleDonors;
                    document.getElementById('adminPendingRequests').textContent = json.pendingRequests;
                    document.getElementById('adminMatchedRequests').textContent = json.matchedRequests;

                    const by = json.byBloodGroup || {};
                    const container = document.getElementById('adminBloodList');
                    container.innerHTML = '';
                    Object.keys(by).sort().forEach(k => {
                        const el = document.createElement('div');
                        el.className = 'blood-group-item';
                        el.innerHTML = `<strong>${k}</strong><span>${by[k]}</span>`;
                        container.appendChild(el);
                    });
                    loadAdminTrends();
                    loadUrgentRequests();
                }
            } catch (e) {
                console.error('Failed to load admin summary', e);
            }
        }

        async function loadAdminTrends() {
            try {
                const res = await fetch('/patient/donor-admin/api/summary/trends');
                const json = await res.json();
                if (!json || !json.success) return;
                const labels = json.labels || [];
                const donors = json.donors || [];
                const requests = json.requests || [];

                const ctx = document.getElementById('trendChart').getContext('2d');
                if (trendChart) {
                    trendChart.data.labels = labels;
                    trendChart.data.datasets[0].data = donors;
                    trendChart.data.datasets[1].data = requests;
                    trendChart.update();
                    return;
                }
                if (typeof Chart === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const s = document.createElement('script');
                        s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
                        s.onload = resolve;
                        s.onerror = reject;
                        document.head.appendChild(s);
                    });
                }

                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Donors',
                                data: donors,
                                borderColor: '#d32f2f',
                                backgroundColor: 'rgba(211,47,47,0.12)',
                                tension: 0.3
                            },
                            {
                                label: 'Requests',
                                data: requests,
                                borderColor: '#1976d2',
                                backgroundColor: 'rgba(25,118,210,0.10)',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: { x: { display: true }, y: { beginAtZero: true } }
                    }
                });
            } catch (e) {
                console.error('Failed to load trends', e);
            }
        }

        async function loadUrgentRequests() {
            try {
                const res = await fetch('/patient/donor-admin/api/requests/urgent');
                const json = await res.json();
                const tbody = document.getElementById('urgentBody');
                tbody.innerHTML = '';
                if (!json || !json.success) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999; padding: 20px 8px; font-size: 12px;">‚ö†Ô∏è No data</td></tr>';
                    return;
                }
                const data = json.data || [];
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666; padding: 20px 8px; font-size: 12px;">‚úì No urgent requests</td></tr>';
                    return;
                }
                data.forEach(r => {
                    const tr = document.createElement('tr');
                    const reqDate = r.requiredDate ? new Date(r.requiredDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : '';
                    tr.innerHTML = `<td class="urgent-req-id">${r.id}</td>
                        <td class="urgent-req-name">${r.name || 'N/A'}</td>
                        <td class="urgent-req-blood">${r.bloodGroup || 'N/A'}</td>
                        <td class="urgent-req-date">${reqDate}</td>
                        <td style="text-align: center;"><button onclick="markRequestMatched(${r.id})" class="urgent-req-btn">‚úì Match</button></td>`;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Failed to load urgent requests', e);
            }
        }

        async function markRequestMatched(id) {
            if (!confirm('Mark request ' + id + ' as Matched?')) return;
            try {
                const res = await fetch('/patient/donor-admin/api/request/' + id + '/mark-matched', { method: 'POST' });
                const json = await res.json();
                if (json && json.success) {
                    alert('Request marked matched');
                    loadAdminSummary();
                } else {
                    alert('Failed: ' + (json && json.message ? json.message : 'unknown'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
    </script>
</section>
</body>
</html>